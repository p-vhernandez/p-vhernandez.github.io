<!DOCTYPE html>
<html>
    <head>

        <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
        <meta content="utf-8" http-equiv="encoding">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">

        <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Nunito&display=swap" rel="stylesheet">

        <title>AB Testing Team 3</title>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js">
        </script>

        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-app.js"></script>

        <!-- TODO: Add SDKs for Firebase products that you want to use
            https://firebase.google.com/docs/web/setup#available-libraries -->
        <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.4.3/firebase-analytics.js"></script>

        <script>

            let firebaseConfig = {
                apiKey: "AIzaSyDzuCmLyZDZVx5EcwbOF8bTBTgoKmV3aLg",
                authDomain: "evaluation-abtesting.firebaseapp.com",
                databaseURL: "https://evaluation-abtesting-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "evaluation-abtesting",
                storageBucket: "evaluation-abtesting.appspot.com",
                messagingSenderId: "493242964737",
                appId: "1:493242964737:web:b1a9ca8d906542844c9900",
                measurementId: "G-ELNLGRZKZ8"
            };
            
            firebase.initializeApp(firebaseConfig);

            let db = firebase.firestore();
            firebase.analytics();

            function getCookie(cname) {

                let name = cname + "=";
                let decodedCookie = decodeURIComponent(document.cookie);
                let ca = decodedCookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "cookie_not_found";

            }

            function setCookie(cname, cvalue, exdays) {

                let d = new Date();
                let extratime = exdays*24*60*60*1000;
                d.setTime(d.getTime() + (extratime));
                let expires = " expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + "; path=/; samesite=lax";

            }

            function cookieExists(cname) {
                return (getCookie(cname) != "cookie_not_found" ? true : false);
            }

            function getStandardDeviation (array) {
                const n = array.length;
                const mean = array.reduce((a, b) => a + b) / n;
                return Math.sqrt(array.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / n);
            }

            function getTwoMeansZValue(parameters) {
                // verbose on purpose

                let sm1 = parameters.sampleMean1,
                    sm2 = parameters.sampleMean2,
                    delta = parameters.popDelta,
                    sd1 = parameters.stdDev1,
                    sd2 = parameters.stdDev2,
                    size1 = parameters.sampleSize1,
                    size2 = parameters.sampleSize2;

                let numerator = (sm1 - sm2) - delta;

                let d1 = ((sd1**2)/size1);
                let d2 = ((sd2**2)/size2);
                let denominator = Math.sqrt(d1 + d2);

                return (numerator/denominator);
            }

            function getPValue(z) 
            {
                // z == number of standard deviations from the mean

                // if z is greater than 6.5 standard deviations from the mean
                // the number of significant digits will be outside of a reasonable 
                // range
                if (z < -6.5)
                    return 0.0;
                if (z > 6.5) 
                    return 1.0;

                let factK = 1;
                let sum = 0;
                let term = 1;
                let k = 0;
                let loopStop = Math.exp(-23);

                while(Math.abs(term) > loopStop) 
                {
                    term = .3989422804 * Math.pow(-1,k) * Math.pow(z,k) / (2 * k + 1) / Math.pow(2,k) * Math.pow(z,k+1) / factK;
                    sum += term;
                    k++;
                    factK *= k;

                }

                sum += 0.5;

                return (1 - sum);
            }

            function start() {
                let rightTimes = new Array();
                let leftTimes = new Array();
                let joinList = 0;

                let popSize = 500,
                    currentPartition = 0,
                    totPartitions = 50,
                    expPower = 80,
                    currentSampleSize = 0,
                    sumRight = 0,
                    sumLeft = 0,
                    sampleMeanRight, 
                    sampleMeanLeft,
                    popMeanRight = 10000,
                    popMeanLeft = 13000,
                    popDelta = popMeanLeft - popMeanRight,
                    stdDevRight = 0,
                    stdDevLeft = 0,
                    zValue = 0,
                    pValue = 0;

                // for now I'll use the two sample z test

                // protip: use the left one as baseline/population so you'll see 
                // whether the right one is statistically-significantly better?

                db.collection("index").get().then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // doc.data() is never undefined for query doc snapshots
                        // console.log(doc.id, " => ", doc.data());
                        if (doc.data().joined) {
                            if (doc.data().button_position == "right")
                                rightTimes.push(doc.data().time_to_join);
                            else
                                leftTimes.push(doc.data().time_to_join);
                            joinList++; // this will be useful for the second hyp
                        }
                    });

                    currentSampleSize = rightTimes.length + leftTimes.length;

                    for (let i = 0; i < rightTimes.length; i++)
                        sumRight += rightTimes[i];
                    
                    sampleMeanRight = sumRight/rightTimes.length;

                    for (let i = 0; i < leftTimes.length; i++)
                        sumLeft += leftTimes[i];

                    sampleMeanLeft = sumLeft/leftTimes.length;

                    stdDevRight = getStandardDeviation(rightTimes);
                    stdDevLeft = getStandardDeviation(leftTimes);

                    let package = {
                        sampleMean1: sampleMeanLeft,
                        sampleMean2: sampleMeanRight,
                        popDelta: popDelta,
                        stdDev1: stdDevLeft,
                        stdDev2: stdDevRight,
                        sampleSize1: leftTimes.length,
                        sampleSize2: rightTimes.length
                    };

                    zValue = getTwoMeansZValue(package);
                    pValue = getPValue(zValue);

                    document.getElementById("stats").innerHTML = "Z = " + zValue + ", p-value = " + pValue + " (" + (pValue >= 0.05 ? "non-" : "") + "significant)";

                    currentPartition = totPartitions - ((popSize - currentSampleSize)/10);

                    if (currentPartition != -1)
                        document.getElementById("latest").innerHTML = "Number of subjects that entered the experiment: " + currentSampleSize + " (" + rightTimes.length + " had the right button position and " + leftTimes.length + " had the left button position)";
                    else
                        document.getElementById("latest").innerHTML = "Error? Current sample size: " + currentSampleSize;

                    document.getElementById("pending").innerHTML = currentPartition + " interim analysis/es done, " + (totPartitions - currentPartition) + " interim analyses pending (total subjects = " + popSize + " for power = " + expPower + "%)";

                    let xValues = ["1/10","2/10","3/10","4/10","5/10","6/10","7/10","8/10","9/10","10/10"];

                    setCookie("z" + currentPartition, zValue, 365);

                    let resultZs = new Array();
                    resultZs[currentPartition-1] = zValue;
                    // WIP: get cookies; you know that there are N previous partitions because that's currentPartition-1, so you can more efficiently cycle through getting them

                    new Chart("myChart", {
                        type: "line",
                        data: {
                            labels: xValues,
                            datasets: [{
                                data: [6.0879, 4.2288, 3.3962, 2.9061, 2.5789, 2.3417, 2.1598, 2.0146, 1.8952, 1.7949],
                                borderColor: "grey",
                                fill: false
                            },
                            {
                                data: [300,700,2000,5000,6000,4000,2000,1000,200,100],
                                borderColor: "purple",
                                fill: false
                            }]
                        },
                        options: {
                            legend: {display: false}
                        }
                    });

                });
            }

        </script>

    </head>

    <body style="font-family: 'Nunito', sans-serif;" onload="start()">
        <div class="jumbotron text-center">
            <h1>Dashboard</h1>
        </div>
        <div class="container">
            <div class="row" class="text-center">
                <h3 id="latest"></h3>
                <br><br>
                <h3 id="stats"></h3>
                <br><br>
                <h3 id="pending"></h3>
                <br><br>
                <canvas id="myChart" style="width:100%;max-width:700px"></canvas>
            </div>
            <div class="row" style="height: 30px;">
                <br><br><br><br><br><br><br><br><br><br>
            </div>
        </div>
    </body>
</html>
